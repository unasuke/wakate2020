# Itamaeã¨ã„ã†IaCãƒ„ãƒ¼ãƒ«ã®CIã«ã¤ã„ã¦
subtitle
: 2020-09-26

subtitle
: ç¬¬53å› æƒ…å ±ç§‘å­¦è‹¥æ‰‹ã®ä¼š

author
: ã†ãªã™ã‘

theme
: unasuke-white

# è‡ªå·±ç´¹ä»‹
- åå‰ : ã†ãªã™ã‘
- æ‰€å± : ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹
  - ã‚¤ãƒ³ãƒ•ãƒ©å¯„ã‚Šã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
  - Itamae ãƒ¡ãƒ³ãƒ†ãƒŠ

- GitHub [@unasuke](https://github.com/unasuke)
- Mastodon {::tag name="x-small"}[@unasuke@mstdn.unasuke.com](https://mstdn.unasuke.com/@unasuke){:/tag}
- Twitter [@yu\_suke1994](https://twitter.com/yu_suke1994)

![](img/icon_raw.jpg){:relative_width="24" align="right" relative_margin_right="-9" relative_margin_top="42"}

# å®£ä¼
- æ˜æ—¥é«˜å°‚DJéƒ¨ã‚’ã‚„ã‚Šã¾ã™ (14:00ã€œ) `#kosendj`
- <https://kosendj-bu.in>
- Twitchã§é…ä¿¡ã™ã‚‹ã®ã§æ°—è»½ã«èãã«ãã¦ãã ã•ã„

![](https://avatars1.githubusercontent.com/u/7091927){:relative_width="30"}

# æœ€åˆã«è¬ç½ª
ã¨ã¦ã‚‚ã˜ã‚ƒãªã„ã‘ã©5åˆ†ã§è©±ã›ã‚‹å†…å®¹ã§ã¯ãªã„ã®ã§ã‚¹ãƒ¼ãƒ‘ãƒ¼æ—©å£ã§è©±ã—ã¾ã™ã€‚
å†…å®¹ãŒæ°—ã«ãªã‚‹æ–¹ã¯ä»Šæ—¥å…¬é–‹äºˆå®šã®ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚‚èª­ã‚“ã§ã„ãŸã ã‘ã‚‹ã¨ã‚ã‚ŠãŒãŸã„ã§ã™ã€‚

# Itamaeã¨ã¯ï¼Ÿ

- Itamae ã¯æ§‹æˆç®¡ç†ãƒ„ãƒ¼ãƒ«
  - Rubyè£½
  - <https://github.com/itamae-kitchen/itamae>
  - ãŠãªã‹ã¾: Puppet, Chef, Ansible
- @ryotarai æ°ã«ã‚ˆã£ã¦ä½œæˆã•ã‚ŒãŸ
- ç¾åœ¨ã®ãƒ¡ãƒ³ãƒ†ãƒŠ @sue445, @ryotarai, @unasuke

![](https://raw.githubusercontent.com/itamae-kitchen/itamae-logos/master/FA-Itamae-horizontal-01.png){:relative_width="40" align="right" relative_margin_right="-9" relative_margin_top="44"}

# Itamaeã¨è‹¥æ‰‹ã®ä¼šã¨åƒ•
- å†¬ã®é™£2018
  - CIãŒé€šã‚‰ãªã„è©±
- ç¬¬51å›
  - ãƒ¡ãƒ³ãƒ†ãƒŠã«ç›´ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã—ãŸè©±
- ç¬¬53å› (ä»Šå›)
  - CIã«ã¤ã„ã¦ (ï¼Ÿ)

ã“ã„ã¤Itamaeã®è©±ã°ã£ã‹ã—ã¦ã‚“ãª

# Itamaeã¨ã„ã†IaCãƒ„ãƒ¼ãƒ«ã®CIã«ã¤ã„ã¦
`travis-ci.org`

![](img/itamae-travis-ci-org.png){:relative_width="100"}

# Itamaeã®CI
ãŸã¾ã«è½ã¡ã‚‹

![](https://img.esa.io/uploads/production/attachments/11214/2020/09/22/3132/813f6402-0ed1-41d3-8ba8-d18cfb8dad4f.png){:relative_width="70"}

# Itamaeã®CI
å†å®Ÿè¡ŒãŒã§ããªã„ï¼ï¼ï¼ï¼

# Itamaeã®CI

{:.center}
{::tag name="xx-large"}ã—ã‹ãŸãªã„ã€ç§»è¡Œã™ã‚‹ã{:/tag}

# å‰æçŸ¥è­˜: Itamaeã®testã«ã¤ã„ã¦

- Rubyã®version
    - 2.3ã‹ã‚‰headã¾ã§ã®6 versions
- JITã®æœ‰ç„¡
    - 2.6ä»¥ä¸Šã®Ruby(3 versions)ã«å¯¾ã—ã¦
- unitãªã®ã‹integrationãªã®ã‹
  - å®Ÿè¡Œã™ã‚‹ç’°å¢ƒãŒç•°ãªã‚‹

# OSSã®CIãƒ„ãƒ¼ãƒ«
public repoã®CIãŒç„¡æ–™ãªã®ã¯ã€æœ‰åãªã®ã¯ã“ã‚Œã‚‰

- GitHub Actions
- CircleCI

# GitHub Actionsã§Itamaeã®CI
ã¾ãšã¯GitHub Actionsã‚’ã‚„ã£ã¦ã¿ã‚ˆã†

# GitHub Actionsã§Itamaeã®unit test

```yaml
name: "unit test on ubuntu"

on:
  push:
    branches: "*"
jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-16.04, ubuntu-18.04]
        ruby: [2.2, 2.3, 2.4, 2.5, 2.6, 2.7, head]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
      - run: bundle install
      - run: bundle exec rake spec:unit
```

# GitHub Actionsã§Itamaeã®unit test
![](img/itamae-unit-test-on-github-actions.png){:relative_width="100"}

é€šã‚‹

# GitHub Actionsã§Itamaeã®integration test

![](https://img.esa.io/uploads/production/attachments/11214/2020/09/22/3132/98cb8295-cb03-48a0-b5b7-a1afb28abbae.png){:relative_height="90"}

é€šã‚‰ãªã„ï¼ï¼ï¼ï¼ï¼

# integration testãŒé€šã‚‰ãªã„
![](https://i.gyazo.com/6d46d55a7597eaddd0b65b7fd04b85cc.png){:relative_height="100"}

# integration testãŒé€šã‚‰ãªã„
![](https://i.gyazo.com/7e851a2ffb6067362d92571a1687b2fc.png){:relative_height="100"}

# integration testãŒé€šã‚‰ãªã„
- tmpãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿ã§ã‚³ã‚±ã‚‹
- {::tag name="xx-large"}straceã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨é€šã‚‹{:/tag}
  - ãªã‚“ã§ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ
- ã•ã™ãŒã«èª¿æŸ»ãŒã—ã‚“ã©ã„ã®ã§æ¡ç”¨è¦‹é€ã‚Š

# CircleCIã§Itamaeã®CI
ã§ã¯CircleCIã‚’ã‚„ã£ã¦ã¿ã‚ˆã†

# .circleci/config.yml

```yaml
version: 2.1
orbs:
  ruby: circleci/ruby@1.0.7

executors:
  docker:
    docker:
      - image: cimg/base:stable
  docker-1804:
    docker:
      - image: cimg/base:stable-18.04
  machine:
    machine:
      image: circleci/classic:201808-01

jobs:
  unit:
    parameters:
      ruby-version:
        type: string
      exec:
        type: executor
        default: ""
    executor: << parameters.exec >>
    steps:
      - checkout
      - ruby/install:
          version: << parameters.ruby-version >>
      - run: gem install bundler --version 1.17.3 --force
      - run: bundle install -j4
      - run: ruby -v
      - run: bundle exec rake spec:unit
  integration:
    parameters:
      ruby-version:
        type: string
    executor: machine
    # executor: docker
    steps:
      - checkout
      - setup_remote_docker:
          version: 18.06.0-ce
      - ruby/install:
          version: << parameters.ruby-version >>
      - run: gem install bundler --version 1.17.3 --force
      - run: bundle install -j4
      - run:
          command: |
            ruby -v
            export PATH=$HOME/.rvm/bin:$PATH
            ruby -v
      - run: bundle exec rake spec:integration:all
  unit-jit:
    parameters:
      ruby-version:
        type: string
    executor: docker
    steps:
      - checkout
      - ruby/install:
          version: << parameters.ruby-version >>
      - run: gem install bundler --version 1.17.3 --force
      - run: bundle install -j4
      - run: ruby -v
      - run: RUBYOPT=--jit bundle exec rake spec:unit
  integration-jit:
    parameters:
      ruby-version:
        type: string
    # executor: machine
    executor: docker
    steps:
      - checkout
      - setup_remote_docker:
          version: 18.06.0-ce
      - ruby/install:
          version: << parameters.ruby-version >>
      - run: gem install bundler --version 1.17.3 --force
      - run: bundle install -j4
      - run: ruby -v
      - run: RUBYOPT=--jit bundle exec rake spec:integration:all

workflows:
  version: 2
  all-test:
    jobs:
      - unit:
          exec:
            name: docker-1804
          matrix:
            parameters:
              ruby-version: ["2.3"]
      - unit:
          exec:
            name: docker
          matrix:
            parameters:
              ruby-version: ["2.4", "2.5", "2.6", "2.7"]
      - integration:
          matrix:
            parameters:
              ruby-version: ["2.3", "2.4", "2.5", "2.6", "2.7"]
  # all-test-with-jit:
  #   jobs:
      - unit-jit:
          matrix:
            parameters:
              ruby-version: ["2.6", "2.7"]
      - integration-jit:
          matrix:
            parameters:
              ruby-version: ["2.6", "2.7"]
```

èª­ã‚ã¾ã›ã‚“ãŒèª­ã¾ãªãã¦ã„ã„ã§ã™

# CircleCIã§Itamaeã®CIã€å£ãŸã¡
1. ruby/install-depsã®æŒ™å‹•
2. machine executorã§Rubyã®versionãŒè¨­å®šã§ããªã„ï¼Ÿ
3. setup_remote_dockerã§ã¯volume mountãŒä½¿ãˆãªã„

# 1. ruby/install-depsã®æŒ™å‹•
- CircleCIå…¬å¼Orb `circleci/ruby` ã‚’ä½¿ç”¨
- `Gemfile.lock` ãŒã‚ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¦ã„ã‚‹
  - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‘ãã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå‘ãã§ã¯ãªã„
  - åˆ¥ã«ãªãã¦ã‚‚ã„ã„ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³æŒ‡å®šå¯èƒ½)
- bundlerã®é‡è¤‡ã‚’è§£æ±ºã§ããªã„ï¼

çµå±€ `gem install bundler --force` ã‚’æ‰‹æ›¸ãã—ãªã„ã¨ã„ã‘ãªã„

# 2. machine executorã§Rubyã®versionãŒè¨­å®šã§ããªã„ï¼Ÿ
- docker executorã¨machine executorã®2ç¨®é¡ãŒã‚ã‚‹
  - integration testã¯Dockerã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚machine executorã‚’ä½¿ã„ãŸã„
- machine executorã§ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ã‚‹

![](https://i.gyazo.com/bdc46bcefeb3529b4a3ee3eff9216436.png){:relative_width="100"}

# 2. machine executorã§Rubyã®versionãŒè¨­å®šã§ããªã„ï¼Ÿ
- Ruby 2.6ãªã®ã« `--jit` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¸¡ã›ãªã„ï¼Ÿ

![](https://i.gyazo.com/bdc46bcefeb3529b4a3ee3eff9216436.png){:relative_width="100"}

# 2. machine executorã§Rubyã®versionãŒè¨­å®šã§ããªã„ï¼Ÿ
Ruby 2.6ã®ãƒ†ã‚¹ãƒˆã§Rubyã®versionã‚’å‡ºåŠ›ã—ã¦ã¿ã‚‹ã¨ã€ã“ã†

![](img/itamae-machine-ruby-jit.png){:relative_width="90"}

Ruby 2.3ã«ãªã£ã¨ã‚‹ã‚„ã‚“ã‘ï¼ï¼ï¼ï¼ï¼ï¼

# 2. machine executorã§Rubyã®versionãŒè¨­å®šã§ããªã„ï¼Ÿ
- machine executorã«ãŠã„ã¦ `circleci/ruby` ãŒã†ã¾ãå‹•ã‹ãªã„
  - RVMã®PATHãŒä½•åº¦ã‚„ã£ã¦ã‚‚é€šã‚‰ãªã„
  - ãã‚‚ãã‚‚ãã‚“ãªãƒãƒƒã‚¯ã—ãŸããªã„
- ã—ã‹ãŸãªã„ã€setup_remote_dockerã—ã‚ˆã†

# 3. setup_remote_dockerã§ã¯volume mountãŒä½¿ãˆãªã„
- CircleCIã®docker executorå†…ã§dockerã‚’ä½¿ç”¨ã™ã‚‹ã—ãã¿
  - ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¿ã‚‹ã¨è½ã¡ã‚‹
  - ã©ã†ã‚„ã‚‰volume mountã«å¤±æ•—ã—ã¦ã„ã‚‹ï¼Ÿ

> ã‚¸ãƒ§ãƒ–ç©ºé–“ã‹ã‚‰ãƒªãƒ¢ãƒ¼ãƒˆ Docker å†…ã®ã‚³ãƒ³ãƒ†ãƒŠã«ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã“ã¨ (ãŠã‚ˆã³ãã®é€†) ã¯ã§ãã¾ã›ã‚“ã€‚
> https://circleci.com/docs/ja/2.0/building-docker-images/#section=configuration

ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­

# çµæœ
CircleCIã®æ¡ç”¨ã‚‚è¦‹é€ã‚Šâ€¦â€¦
\\n
(60å›ãã‚‰ã„CIã‚’å›ã—ã¦ã„ã‚‹)

# what's the next ci platform?
çš†ã•ã‚“ã®ãŠå¥½ããªCIã‚’æ€ã„ã†ã‹ã¹ã¦ã¿ã¾ã—ã‚‡ã†

# Itamaeã¯travis-ci.orgã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹
- `travis-ci.org` ã§ã™

# travis-ci.com
![](img/travis-ci-com.png){:relative_width="80"}

<https://blog.travis-ci.com/2018-05-02-open-source-projects-on-travis-ci-com-with-github-apps>

# Itamaeã¯travis-ci.orgã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹
- `travis-ci.org` ã§ã™
- `travis-ci.org` ã‹ã‚‰ `travis-ci.com` ã«ç§»è¡Œã™ã‚‹ã¨ã€ã©ã†ãªã‚‹ï¼Ÿ

# Itamae CI on travis-ci.com
![](img/itamae-on-travic-ci-com.png){:relative_width="100"}

"Restart build" ã§ãã‚‹ï¼

# ã¾ã¨ã‚
- CI serviceã«ã¯ã‚¯ã‚»ãŒã‚ã‚‹
- travis-ciã®matrixãŒä¸€ç•ªæ›¸ãã‚„ã™ã„
- çš†ã•ã‚“ã®ã‚³ãƒ¼ãƒ‰ã®CIã€ `travis-ci.com` ã«ç§»è¡Œã§ãã¦ã¾ã™ã‹ï¼Ÿ
  - ãªãœã‚ªãƒ¬ã¯ã‚ã‚“ãªãƒ ãƒ€ãªæ™‚é–“ã‚’â€¦â€¦